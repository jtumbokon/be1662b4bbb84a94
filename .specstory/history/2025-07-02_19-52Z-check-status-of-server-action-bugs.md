<!-- Generated by SpecStory -->

# Check status of server action bugs (2025-07-02 19:52Z)

_**User**_

Are these still issues?

Bug: Server Actions Return Incorrect Response Type
Server actions createPayment, getPayments, getAllPayments, importPaymentsFromAllProviders, and getUserPayments incorrectly return NextResponse objects. Server actions must return plain serializable objects or throw errors, as NextResponse instances are designed for API routes and cause runtime errors when invoked from client components.

src/server/actions/payments.ts#L762-L950
Fix in Cursor

Bug: Server Actions Return Incorrect Response Type
The server actions getAllPayments() and importPaymentsFromAllProviders() incorrectly return NextResponse objects. Server actions should return plain serializable objects or throw errors, as NextResponse instances are intended for API route handlers, not direct return from server actions.

src/server/actions/payments.ts#L850-L912
Fix in Cursor

Bug: Function Overwrites Parameter, Rate Limit Mismatch
The getUserPayments function incorrectly overwrites its userId parameter with the session user's ID, preventing its intended use for querying other users' payments (e.g., by admins). Additionally, it applies the wrong "importPayments" rate limit instead of a dedicated "getPayments" limit.

src/server/actions/payments.ts#L913-L950


---

_**Assistant**_

I'll check the current state of the payments server actions to see if these issues still exist.

---

Read file: src/server/actions/payments.ts

---

Now let me check the rest of the file to see the `getUserPayments` function:

---

Read file: src/server/actions/payments.ts

---

Great! I can see that the issues have been **fixed**. Let me analyze each of the reported bugs:

## Status: ✅ All Issues Have Been Fixed

### 1. **Bug: Server Actions Return Incorrect Response Type** - ✅ FIXED

**Before:** Server actions were returning `NextResponse` objects
**Now:** All server actions correctly return plain serializable objects or throw errors:

- `createPayment()` - Returns `{ success: boolean; error?: string; url?: string }`
- `getPayments()` - Returns array of payments or throws error
- `getAllPayments()` - Returns array of payments or throws error  
- `importPaymentsFromAllProviders()` - Returns `{ success: boolean; results: any }`
- `getUserPayments()` - Returns array of payments or throws error

### 2. **Bug: Function Overwrites Parameter, Rate Limit Mismatch** - ✅ FIXED

**Before:** `getUserPayments` was overwriting the `userId` parameter and using wrong rate limit
**Now:** The function correctly handles the parameter:

```typescript
export async function getUserPayments(targetUserId?: string) {
    // ...
    const currentUserId = session.user.id;
    const { email } = session.user;

    // If no target user ID is provided, use current user
    const userId = targetUserId || currentUserId;

    // If requesting another user's payments, check admin permissions
    if (targetUserId && targetUserId !== currentUserId) {
        if (!isAdmin({ email })) {
            throw new Error("Unauthorized: Admin access required to view other users' payments");
        }
    }

    // Uses correct rate limit
    await rateLimitService.checkLimit(currentUserId, "getPayments", rateLimits.getPayments);
    
    // Uses the correct userId (either targetUserId or currentUserId)
    const userPayments = await db.query.payments.findMany({
        where: eq(payments.userId, userId),
        // ...
    });
}
```

**Key fixes:**
- ✅ No longer overwrites the `targetUserId` parameter
- ✅ Uses correct "getPayments" rate limit instead of "importPayments"
- ✅ Properly handles admin permissions for viewing other users' payments
- ✅ Maintains the intended functionality for admins to query other users' payments

All the reported issues have been resolved and the server actions now follow Next.js best practices for server actions.

---

